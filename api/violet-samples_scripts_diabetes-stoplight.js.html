---
layout: docs
title: 'JSDoc: Source: violet-samples/scripts/diabetes-stoplight.js'
---


  <h1 class="page-title">Source: violet-samples/scripts/diabetes-stoplight.js</h1>


<div id="generatedNav" style="display:none">
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-conversationEngine.html">conversationEngine</a></li><li><a href="module-flowScriptCompiler.html">flowScriptCompiler</a></li><li><a href="module-outputMgr.html">outputMgr</a></li><li><a href="module-response.html">response</a></li><li><a href="module-scriptParser.html">scriptParser</a></li><li><a href="module-utils.html">utils</a></li><li><a href="module-violet.html">violet</a></li><li><a href="module-violetList.html">violetList</a></li><li><a href="module-violetSrvr.html">violetSrvr</a></li><li><a href="module-violetStorePG.html">violetStorePG</a></li><li><a href="module-violetStoreSF.html">violetStoreSF</a></li><li><a href="module-violetTime.html">violetTime</a></li></ul><h3>Classes</h3><ul><li><a href="AlexaPlatform.html">AlexaPlatform</a></li><li><a href="module-conversationEngine-ConversationEngine.html">ConversationEngine</a></li><li><a href="module-conversationEngine-IntentMgr.html">IntentMgr</a></li><li><a href="module-conversationEngine-PlatformMgr.html">PlatformMgr</a></li><li><a href="module-conversationEngine-PlatformPlugin.html">PlatformPlugin</a></li><li><a href="module-conversationEngine-PlatformReq.html">PlatformReq</a></li><li><a href="module-flowScriptCompiler-FlowScriptCompiler.html">FlowScriptCompiler</a></li><li><a href="module-outputMgr-OutputMgr.html">OutputMgr</a></li><li><a href="module-response-Response.html">Response</a></li><li><a href="module-scriptParser-ScriptParser.html">ScriptParser</a></li><li><a href="module-violetList-ListWidget.html">ListWidget</a></li><li><a href="module-violetList-listWidget_.html">listWidget</a></li><li><a href="module-violetStorePG-VioletStorePG.html">VioletStorePG</a></li><li><a href="module-violetStoreSF-VioletStoreSF.html">VioletStoreSF</a></li><li><a href="StorePlugin.html">StorePlugin</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:(unnamed)">(unnamed)</a></li><li><a href="module-conversationEngine.html#~event:closeSession">closeSession</a></li><li><a href="global.html#event:Howdy">Howdy</a></li><li><a href="global.html#event:HowWork">HowWork</a></li><li><a href="global.html#event:Intro">Intro</a></li><li><a href="global.html#event:MajorIntent">MajorIntent</a></li><li><a href="global.html#event:setAlert">setAlert</a></li><li><a href="module-violetTime.html#~event:timeFwd">timeFwd</a></li><li><a href="module-violetTime.html#~event:timeReq">timeReq</a></li><li><a href="global.html#event:unsetAlert">unsetAlert</a></li><li><a href="global.html#event:WakeUp">WakeUp</a></li></ul>
</div>

<div class="codeDocs">
{% raw %}




    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var violet = require('violet/lib/violet.js').script();

var violetTime = require('violet/lib/violetTime')(violet);

var violetSFStore = require('../lib/violetStoreSF.js')(violet);
violetSFStore.store.propOfInterest = {
  'diabetesLog': ['user', 'timeOfCheckin', 'bloodSugarLvl', 'feetWounds', 'missedDosages']
}


const yCall = 'Take action today. Call: 123-456-7890';
const yBloodSugarLo = 70;
const yBloodSugarHi = 130;

const rCall = 'Call your doctor now: 555-555-5555';
const rBloodSugarLo = 70;
const rBloodSugarHi = 130;

violet.addInputTypes({
  "bloodSugarLvl": "NUMBER",
});

//common across multiple goals
violet.addPhraseEquivalents([
]);

violet.addTopLevelGoal('checkIn');

violet.respondTo({
  expecting: ['Check in', 'Can I check in', 'I would like to check in'],
  resolve: (response) => {
   response.say('Sure.');
   response.addGoal('checkIn');
}});

violet.defineGoal({
  goal: 'checkIn',
  prompt: ['Did you check your blood sugar level today?'],
  respondTo: [{
    expecting: ['Yes', 'I tested my blood sugar level'],
    resolve: (response) => {
     response.say('Great.');
     response.addGoal('checkInDetails');
  }}, {
    expecting: ['No', 'I cannot test my blood sugar level'],
    resolve: (response) => {
      response.addGoal('whyCannotTestBloodSugar');
  }}]
});

violet.respondTo({
  expecting: ['Is everything running well'],
  resolve: function *(response) {
  }
});

violet.defineGoal({
  goal: 'checkInDetails',
  resolve: function *(response) {
    if (!response.ensureGoalFilled('timeOfCheckin')
        || !response.ensureGoalFilled('bloodSugarLvl')
        || !response.ensureGoalFilled('feetWounds')
        || !response.ensureGoalFilled('missedDosages') ) {
          return false; // dependent goals not met
        }

    response.say('Thanks for checking in - I am logging the data for you.');

    if (response.get('bloodSugarLvl') &lt; rBloodSugarLo) {
      response.say('Your blood sugar level is very low.');
      response.say(rCall);
    } else if (response.get('bloodSugarLvl') &lt; yBloodSugarLo) {
      response.say('Your blood sugar level is low.');
      response.say(yCall);
    }

    if (response.get('bloodSugarLvl') > rBloodSugarHi) {
      response.say('Your blood sugar level is very high.');
      response.say(rCall);
    } else if (response.get('bloodSugarLvl') > yBloodSugarHi) {
      response.say('Your blood sugar level is high.');
      response.say(yCall);
    }
    // if (response.get('timeOfCheckin') == 'before-my-meal') {
    // } else {
    //   // 2hrs-after-my-meal
    // }

    if (response.get('feetWounds') == true) {
      var diabetesLog = yield response.load('diabetesLog', 'user', response.get('userId'), 'CreatedDate = LAST_N_DAYS:14')
      //console.log('load-results', diabetesLog);

      var sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate()-7);

      var yWarn = true;
      var rWarn = true;
      diabetesLog.forEach((logItem)=>{
        // we have already filtered for the last 14 days
        if (logItem.feetWounds == false) rWarn = false;
        var itemDate = new Date(logItem.CreatedDate);
        if (itemDate.getTime() > sevenDaysAgo.getTime() &amp;&amp; logItem.feetWounds == false) yWarn = false;
      });
      if (rWarn) {
        response.say('Your feet wounds are an indicator of a big problem.');
        response.say(rCall);
      } else if (yWarn){
        response.say('Your feet wounds are an indicator of a problem.');
        response.say(yCall);
      }
    }

    if (response.get('missedDosages') == 'yes') {
      response.say('Your missed dosage is a problem.');
      response.say(yCall);
      // TODO: implement rCall for dosages
    }

    response.store('diabetesLog', {
      'user': response.get('userId'),
      'timeOfCheckin': response.get('timeOfCheckin'),
      'bloodSugarLvl': response.get('bloodSugarLvl'),
      'feetWounds': response.get('feetWounds'),
      'missedDosages': response.get('missedDosages')
    });

}});

violet.defineGoal({
  goal: 'timeOfCheckin',
  prompt: 'Was this before a meal, or 2 hours after a meal?',
  respondTo: [{
    expecting: ['Before', 'Before my meal'],
    resolve: (response) => {
      response.set('timeOfCheckin', 'before-my-meal');
  }}, {
    expecting: ['After', '2 hours after my meal'],
    resolve: (response) => {
      response.set('timeOfCheckin', '2hrs-after-my-meal');
  }}]
});

violet.defineGoal({
  goal: 'bloodSugarLvl',
  prompt: 'What was your blood sugar level?',
  respondTo: [{
    expecting: ['My blood sugar level is [[bloodSugarLvl]]', '[[bloodSugarLvl]]'],
    resolve: (response) => {
      response.set('bloodSugarLvl', response.get('bloodSugarLvl') );
  }}]
});

violet.defineGoal({
  goal: 'feetWounds',
  prompt: 'Do you have any wounds on your feet?',
  respondTo: [{
    expecting: ['No'],
    resolve: (response) => {
      response.set('feetWounds', false );
  }}, {
    expecting: ['Yes'],
    resolve: (response) => {
      response.set('feetWounds', true );
  }}]
});

violet.defineGoal({
  goal: 'missedDosages',
  prompt: 'Did you miss any doses of medicine?',
  respondTo: [{
    expecting: ['No'],
    resolve: (response) => {
      response.set('missedDosages', false );
  }}, {
    expecting: ['Yes'],
    resolve: (response) => {
      response.set('missedDosages', true );
  }}]
});


violet.defineGoal({
  goal: 'whyCannotTestBloodSugar',
  prompt: 'Are you out of strips, not sure how to test, sweaty, shaky, lightheaded, or confused?',
  respondTo: [{
    expecting: ['{I am|} out of strips', '{I have|} no strips'],
    resolve: (response) => {
      response.set('cannotTestBloodSugarReason', 'out-of-strips'); response.say(yCall);
  }}, {
    expecting: '{I am not sure|not sure|} how to test',
    resolve: (response) => {
      response.set('cannotTestBloodSugarReason', 'not-sure-how-to-test'); response.say(yCall);
    }}, {
    expecting: '{I am|} sweaty',
    resolve: (response) => {
      response.set('cannotTestBloodSugarReason', 'sweaty'); response.say(rCall);
    }}, {
    expecting: '{I am|} shaky',
    resolve: (response) => {
      response.set('cannotTestBloodSugarReason', 'shaky'); response.say(rCall);
    }}, {
    expecting: '{I am|} sweaty and shaky',
    resolve: (response) => {
      response.set('cannotTestBloodSugarReason', 'sweaty-and-shaky'); response.say(rCall);
    }}, {
    expecting: '{I am|} lightheaded',
    resolve: (response) => {
      response.set('cannotTestBloodSugarReason', 'lightheaded'); response.say(rCall);
    }}, {
    expecting: '{I am|} confused',
    resolve: (response) => {
      response.set('cannotTestBloodSugarReason', 'confused'); response.say(rCall);
  }}]
});

violetTime.repeat(48*60, ()=>{ violet.addGoal('checkIn'); });

module.exports = violet;
</code></pre>
        </article>
    </section>




{% endraw %}
</div>


<footer class="container">
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Nov 06 2019 21:02:03 GMT-0500 (EST)
</footer>

<script> /*prettyPrint();*/ </script>
<!-- script src="scripts/linenumber.js"> </script -->
<script>
  // prism-ize: add language type and line-numbers
  var codeEntries = document.getElementsByTagName('pre');
  for (var ndx=0; ndx<codeEntries.length; ndx++) {
    var node = codeEntries[ndx];
    if (node.children.length!=1 && node.children[0].tagName!='CODE') continue;
    if (!node.className.match(/lang/)) node.className += ' language-javascript'
    if (node.className.match(/linenums/)) node.className += ' line-numbers'
  }
  // changes '<h3 class="subsection-title">Events</h3>'==><h3 class="subsection-title">Intents</h3>
  var headingEntries = document.getElementsByTagName('h3');
  for (var ndx=0; ndx<headingEntries.length; ndx++) {
    var node = headingEntries[ndx];
    if (node.className !== 'subsection-title') continue;
    if (node.textContent == 'Events') node.textContent = 'Intents';
  }
</script>
