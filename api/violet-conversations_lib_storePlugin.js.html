---
layout: docs
title: 'JSDoc: Source: violet-conversations/lib/storePlugin.js'
---


  <h1 class="page-title">Source: violet-conversations/lib/storePlugin.js</h1>


<div id="generatedNav" style="display:none">
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-conversationEngine.html">conversationEngine</a></li><li><a href="module-flowScriptCompiler.html">flowScriptCompiler</a></li><li><a href="module-outputMgr.html">outputMgr</a></li><li><a href="module-response.html">response</a></li><li><a href="module-scriptParser.html">scriptParser</a></li><li><a href="module-utils.html">utils</a></li><li><a href="module-violet.html">violet</a></li><li><a href="module-violetList.html">violetList</a></li><li><a href="module-violetSrvr.html">violetSrvr</a></li><li><a href="module-violetStorePG.html">violetStorePG</a></li><li><a href="module-violetStoreSF.html">violetStoreSF</a></li><li><a href="module-violetTime.html">violetTime</a></li></ul><h3>Classes</h3><ul><li><a href="AlexaPlatform.html">AlexaPlatform</a></li><li><a href="module-conversationEngine-ConversationEngine.html">ConversationEngine</a></li><li><a href="module-conversationEngine-IntentMgr.html">IntentMgr</a></li><li><a href="module-conversationEngine-PlatformMgr.html">PlatformMgr</a></li><li><a href="module-conversationEngine-PlatformPlugin.html">PlatformPlugin</a></li><li><a href="module-conversationEngine-PlatformReq.html">PlatformReq</a></li><li><a href="module-flowScriptCompiler-FlowScriptCompiler.html">FlowScriptCompiler</a></li><li><a href="module-outputMgr-OutputMgr.html">OutputMgr</a></li><li><a href="module-response-Response.html">Response</a></li><li><a href="module-scriptParser-ScriptParser.html">ScriptParser</a></li><li><a href="module-violetList-ListWidget.html">ListWidget</a></li><li><a href="module-violetList-listWidget_.html">listWidget</a></li><li><a href="module-violetStorePG-VioletStorePG.html">VioletStorePG</a></li><li><a href="module-violetStoreSF-VioletStoreSF.html">VioletStoreSF</a></li><li><a href="StorePlugin.html">StorePlugin</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:(unnamed)">(unnamed)</a></li><li><a href="module-conversationEngine.html#~event:closeSession">closeSession</a></li><li><a href="global.html#event:Howdy">Howdy</a></li><li><a href="global.html#event:HowWork">HowWork</a></li><li><a href="global.html#event:Intro">Intro</a></li><li><a href="global.html#event:MajorIntent">MajorIntent</a></li><li><a href="global.html#event:setAlert">setAlert</a></li><li><a href="module-violetTime.html#~event:timeFwd">timeFwd</a></li><li><a href="module-violetTime.html#~event:timeReq">timeReq</a></li><li><a href="global.html#event:unsetAlert">unsetAlert</a></li><li><a href="global.html#event:WakeUp">WakeUp</a></li></ul>
</div>

<div class="codeDocs">
{% raw %}




    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* Copyright (c) 2017-present, salesforce.com, inc. All rights reserved */
/* Licensed under BSD 3-Clause - see LICENSE.txt or git.io/sfdc-license */

class StoreResponseMixin {
  /**
   * Retrieves the given object from the Salesforce database.
   *
   * @param {Object} queryParams - query parameters
   * @param {string} queryParams.objName - the object/table name in the data
   *   store where the give object is to be updated
   * @param {string} queryParams.keyName - the key name to find the object to be updated
   * @param {string} queryParams.keyVal - the key value to find the object to be updated
   * @param {string} queryParams.query - the SOQL query, i.e. what gets executed is "SELECT &lt;query>"
   * @param {string} queryParams.filter - additional query results filter - this
   *  is added to the end of the SQL query
   * @param {string} queryParams.queryXtra - additional bits to be
   *  added to the end of the query, for example "LIMIT 100". "LIMIT 100" is auto added.
   *  Use false to prevent auto adding, for example when using aggregate queries.
   * alternatively, can pass in params as: objName, keyName, keyVal, filter, queryXtra
  */
  load(params) {
    if (arguments.length>1) {
      var p = {};
      if (arguments[0]) p.objName   = arguments[0];
      if (arguments[1]) p.keyName   = arguments[1];
      if (arguments[2]) p.keyVal    = arguments[2];
      if (arguments[3]) p.filter    = arguments[3];
      if (arguments[4]) p.queryXtra = arguments[4];
      params = p;
    }

    if (!params.objName &amp;&amp; !params.query) {
      console.log('Need object or query to load');
      return Promise.resolve();
    }

    if (!params.query) params.query = ''
    if (typeof params.queryXtra === "undefined") params.queryXtra = ''
    if (params.queryXtra !== false &amp;&amp; params.query.toLowerCase().indexOf('limit') == -1 &amp;&amp;
          params.queryXtra.toLowerCase().indexOf('limit') == -1)
      params.queryXtra += ' limit 100';

    if (params.objName)
      console.log('Loading object: ' + params.objName);
    else
    console.log('Loading: ', params);
    return this.persistentStore.load(params);
  }
  store(objName, dataToStore) {
    console.log('Storing object: ' + objName);
    return this.persistentStore.store(objName, dataToStore);
  }
  update(objName, keyName, keyVal, updateData) {
    console.log('Updating object: ' + objName);
    return this.persistentStore.update(objName, keyName, keyVal, updateData);
  }
  delete(objName, keyName, keyVal, deleteData) {
    console.log('Deleting object: ' + objName);
    return this.persistentStore.delete(objName, keyName, keyVal, deleteData);
  }
}

/**
 * Reusable functionality for a store plugin to leverage - also sets up methods
 * that can be accessed from the response object provided to intents.
 */
class StorePlugin {

  constructor(violet) {
    if (violet) violet.registerResponseDecorator(this);
  }

  initResponse(response) {
    var srn = new StoreResponseMixin();
    response.persistentStore = this;
    Reflect.ownKeys(Reflect.getPrototypeOf(srn)).forEach(meth=>{
      if (meth === 'constructor') return;
      response[meth] = srn[meth];
    })
    return response;
  }

  // methods starting with _ are 'protected', i.e. only for use by implementing stores

  _dedupe(ary) {
    return ary.sort().filter((item, ndx, _ary)=>{
      if (ndx!=0 &amp;&amp; item == ary[ndx-1]) return false;
      return true;
    });
  }

  _nameToStr(commonName) {
    return commonName
  }

  _getCompoundNameToStr(commonName) {
    var names = commonName.split('.');
    var ret = '';
    names.forEach((n)=>{
      if (ret.length>0) ret+='.';
      ret+=this._nameToStr(n);
    });
    return ret;
  }

  _objProps(params) {
    var objProps = [];
    if (params.objName) objProps = objProps.concat(this.propOfInterest[params.objName]);
    if (params.propOfInterest) objProps = objProps.concat(params.propOfInterest);
    if (objProps.length == 0) return objProps; // return empty array if we don't have a way to get any propOfInterest
    return objProps.concat(this.defaultPropOfInterest);
  }

  _buildQuery(params) {
    var q = 'SELECT ';
    if (params.query)
      q+=' ' + params.query;
    else
      q+= this._dedupe(this._objProps(params).map((p)=>{return this._getCompoundNameToStr(p);})).join(', ');
    if (params.objName)
      q+= ' FROM ' + this._getCompoundNameToStr(params.objName);
    if (params.keyName || params.filter) q+= ' WHERE';
    if (params.keyName &amp;&amp; params.keyVal) {
      if (params.keyName.startsWith(params.objName))
        q+= ' ' + this._getCompoundNameToStr(params.keyName.substr(params.objName.length+1)) + ' = \'' + params.keyVal + '\'';
      else
        q+= ' ' + this._getCompoundNameToStr(params.keyName)+' = \'' + params.keyVal + '\'';
    }
    if (params.keyName &amp;&amp; params.keyVal &amp;&amp; params.filter) q+= ' AND'
    if (params.filter) q+=' ' + params.filter;
    if (params.queryXtra) q+=' ' + params.queryXtra;

    return q;
  }

}

module.exports = StorePlugin;
</code></pre>
        </article>
    </section>




{% endraw %}
</div>


<footer class="container">
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Aug 27 2019 22:19:04 GMT-0400 (EDT)
</footer>

<script> /*prettyPrint();*/ </script>
<!-- script src="scripts/linenumber.js"> </script -->
<script>
  // prism-ize: add language type and line-numbers
  var codeEntries = document.getElementsByTagName('pre');
  for (var ndx=0; ndx<codeEntries.length; ndx++) {
    var node = codeEntries[ndx];
    if (node.children.length!=1 && node.children[0].tagName!='CODE') continue;
    if (!node.className.match(/lang/)) node.className += ' language-javascript'
    if (node.className.match(/linenums/)) node.className += ' line-numbers'
  }
  // changes '<h3 class="subsection-title">Events</h3>'==><h3 class="subsection-title">Intents</h3>
  var headingEntries = document.getElementsByTagName('h3');
  for (var ndx=0; ndx<headingEntries.length; ndx++) {
    var node = headingEntries[ndx];
    if (node.className !== 'subsection-title') continue;
    if (node.textContent == 'Events') node.textContent = 'Intents';
  }
</script>
