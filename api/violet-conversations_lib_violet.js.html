---
layout: docs
title: 'JSDoc: Source: violet-conversations/lib/violet.js'
---


  <h1 class="page-title">Source: violet-conversations/lib/violet.js</h1>


<div id="generatedNav" style="display:none">
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-conversationEngine.html">conversationEngine</a></li><li><a href="module-flowScriptCompiler.html">flowScriptCompiler</a></li><li><a href="module-outputMgr.html">outputMgr</a></li><li><a href="module-response.html">response</a></li><li><a href="module-scriptParser.html">scriptParser</a></li><li><a href="module-utils.html">utils</a></li><li><a href="module-violet.html">violet</a></li><li><a href="module-violetList.html">violetList</a></li><li><a href="module-violetSrvr.html">violetSrvr</a></li><li><a href="module-violetStorePG.html">violetStorePG</a></li><li><a href="module-violetStoreSF.html">violetStoreSF</a></li><li><a href="module-violetTime.html">violetTime</a></li></ul><h3>Classes</h3><ul><li><a href="AlexaPlatform.html">AlexaPlatform</a></li><li><a href="module-conversationEngine-ConversationEngine.html">ConversationEngine</a></li><li><a href="module-conversationEngine-IntentMgr.html">IntentMgr</a></li><li><a href="module-conversationEngine-PlatformMgr.html">PlatformMgr</a></li><li><a href="module-conversationEngine-PlatformPlugin.html">PlatformPlugin</a></li><li><a href="module-conversationEngine-PlatformReq.html">PlatformReq</a></li><li><a href="module-flowScriptCompiler-ConvoDoc.html">ConvoDoc</a></li><li><a href="module-flowScriptCompiler-ConvoEl.html">ConvoEl</a></li><li><a href="module-flowScriptCompiler-FlowScriptCompiler.html">FlowScriptCompiler</a></li><li><a href="module-outputMgr-OutputMgr.html">OutputMgr</a></li><li><a href="module-response-Response.html">Response</a></li><li><a href="module-scriptParser-ScriptParser.html">ScriptParser</a></li><li><a href="module-violetList-ListWidget.html">ListWidget</a></li><li><a href="module-violetList-listWidget_.html">listWidget</a></li><li><a href="module-violetStorePG-VioletStorePG.html">VioletStorePG</a></li><li><a href="module-violetStoreSF-VioletStoreSF.html">VioletStoreSF</a></li><li><a href="StorePlugin.html">StorePlugin</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:(unnamed)">(unnamed)</a></li><li><a href="module-conversationEngine.html#~event:closeSession">closeSession</a></li><li><a href="global.html#event:Howdy">Howdy</a></li><li><a href="global.html#event:HowWork">HowWork</a></li><li><a href="global.html#event:Intro">Intro</a></li><li><a href="global.html#event:MajorIntent">MajorIntent</a></li><li><a href="global.html#event:setAlert">setAlert</a></li><li><a href="module-violetTime.html#~event:timeFwd">timeFwd</a></li><li><a href="module-violetTime.html#~event:timeReq">timeReq</a></li><li><a href="global.html#event:unsetAlert">unsetAlert</a></li><li><a href="global.html#event:WakeUp">WakeUp</a></li></ul>
</div>

<div class="codeDocs">
{% raw %}




    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* Copyright (c) 2017-present, salesforce.com, inc. All rights reserved */
/* Licensed under BSD 3-Clause - see LICENSE.txt or git.io/sfdc-license */

/**
 * This is the Core Violet Module - it returns the conversation engine that
 * voice scripts can take advantage of.
 * &lt;br>&lt;br>
 * Voice scripts can be grouped into a single app and multiple apps can be made
 * available on a single server. Currently Violet supports registering
 * intents for Amazon's Alexa Skills Kit and Google's Dialogflow platform.
 *
 * @module violet
 */

var path = require('path');

var ConversationEngine = require('./conversationEngine.js');


///////////
///////////

var serverInstantiated = false;
var appName = null; // set when loading a set of scripts
var appToVioletConversationEngines = {};

/**
 * Assists with the loading of scripts by a Server. Primarily enables
 * apps to have multiple scripts.
 */
module.exports.server = function() {
  serverInstantiated = true;
  return {
    loadScript: (contextDir, scriptPath, name, svcRouter) => {
      appName = name;
      require(path.join(contextDir, scriptPath));
      const script = module.exports.script();
      script.registerIntents();
      script.platforms.setServerApp(svcRouter);
      return script;
    },
    loadMultipleScripts: (contextDir, scriptPaths, name, svcRouter) => {
      appName = name;
      scriptPaths.forEach(p=>{
        // all instances of script below should be identical
        require(path.join(contextDir, p));
      })
      const script = module.exports.script();
      script.registerIntents();
      script.platforms.setServerApp(svcRouter);
      return script;
    }
  };
}
/**
 * Violet intentionally groups scripts into an app. The method clears any
 * previous script information for the specified app. This
 * method is primarily used by the test suite as it uses the same app repeatedly.
 *
 * @param appName - App name to reset script information.
 */
module.exports.clearAppInfo = function(_appName) {
  delete appToVioletConversationEngines[_appName];
};

/**
 * Instantiates and returns the Violet Conversation Engine. Most violet scripts
 * start by making this call.
 *
 * @param {Object} cfg - script config
 * @param cfg.appName - (optional) Essentially a unique id for the script. Having a
 * shared id between two scripts will mean that they add to the same
 * ConversationEngine object. Not setting this parameter will mean that Violet
 * will attach this script to the previous App. It is
 * recommended to not set this parameter (in the script) but to define it
 * in the parent where the script is being loaded.
 * @param cfg.invocationName - (optional) Used when configuring skills by the Alexa
 * platform and the web voice tooling
 * @param {Object[]} cfg.platforms - (optional) Voice Platforms to support. Each
 * item in the array is expected to have keys called 'endpoint' and 'platform'.
 * Not setting this parameter will mean that Violet will support both Alexa (at
 * /alexa) and Google (at /google).
 * @returns {ConversationEngine} - The primary
 * {@link module:conversationEngine~ConversationEngine ConversationEngine} object that Voice Apps will use to define
 * scripts, intents, goals, etc.
 */
module.exports.script = function(cfg, cfgExtra) {
  if (!cfg) cfg = {};

  // keeping backward compatability
  if (cfg &amp;&amp; typeof cfg === 'string') cfg = { appName: cfg };
  if (cfgExtra) cfg.platforms = cfgExtra;

  // setup defaults
  if (!cfg.platforms) {
    cfg.platforms = [
      {endpoint: 'alexa', platform: require('./alexaPlatform.js')},
      {endpoint: 'google', platform: require('./googlePlatform.js')},
    ];
  }

  if (appName == null &amp;&amp; cfg.appName == null &amp;&amp; cfg.invocationName != null) cfg.appName = cfg.invocationName.replace(/ /g,'_');
  if (appName == null &amp;&amp; cfg.appName != null) appName = cfg.appName;

  // run server automatically if it has not been setup
  if (!serverInstantiated) {
    // allow scripts to be launched without the server and instead just initialize after 1s
    var violetSrvr = require('./violetSrvr.js')();
    violetSrvr.createAndListen(process.env.PORT || 8080);
    serverInstantiated = true;
    appName = ''
    setTimeout(()=>{ // run after the full script loads
      violet.registerIntents();
      var appRouter = violetSrvr.getAppRouter(appName);
      violet.platforms.setServerApp(appRouter);
      violetSrvr.installTooling(appRouter, violet);
    }, 1*1000);
  }

  // reuse already setup engine (to promote modularity)
  if (appToVioletConversationEngines[appName]) return appToVioletConversationEngines[appName];

  var violet = new ConversationEngine(appName, cfg);

  appToVioletConversationEngines[appName] = violet;
  return violet;
};
</code></pre>
        </article>
    </section>




{% endraw %}
</div>


<footer class="container">
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Mar 14 2020 19:07:22 GMT-0400 (EDT)
</footer>

<script> /*prettyPrint();*/ </script>
<!-- script src="scripts/linenumber.js"> </script -->
<script>
  // prism-ize: add language type and line-numbers
  var codeEntries = document.getElementsByTagName('pre');
  for (var ndx=0; ndx<codeEntries.length; ndx++) {
    var node = codeEntries[ndx];
    if (node.children.length!=1 && node.children[0].tagName!='CODE') continue;
    if (!node.className.match(/lang/)) node.className += ' language-javascript'
    if (node.className.match(/linenums/)) node.className += ' line-numbers'
  }
  // changes '<h3 class="subsection-title">Events</h3>'==><h3 class="subsection-title">Intents</h3>
  var headingEntries = document.getElementsByTagName('h3');
  for (var ndx=0; ndx<headingEntries.length; ndx++) {
    var node = headingEntries[ndx];
    if (node.className !== 'subsection-title') continue;
    if (node.textContent == 'Events') node.textContent = 'Intents';
  }
</script>
